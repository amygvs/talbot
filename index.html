<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Talbot - Your Mental Health Companion</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Talbot">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRhbGJvdCAtIE1lbnRhbCBIZWFsdGggQ29tcGFuaW9uIiwKICAic2hvcnRfbmFtZSI6ICJUYWxib3QiLAogICJkZXNjcmlwdGlvbiI6ICJZb3VyIHBlcnNvbmFsIG1lbnRhbCBoZWFsdGggYXNzaXN0YW50IGZvciBzdXBwb3J0IGJldHdlZW4gdGhlcmFweSBzZXNzaW9ucyIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmN2ZhIiwKICAidGhlbWVfY29sb3IiOiAiIzRBOTBFMiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5USTBJaUJvWldsbmFIUTlJalV5TkNJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV5TkNBMU1qUWlJR1pwYkd3OUlpTTBRVGt3UlRJaVBnbzhZMmx5WTJ4bElHTjRQU0l5TmpJaUlHTjVQU0l5TmpJaUlISTlJamMySWlCbWFXeHNQU0lqWmptbWFTSXZQZ2s4WTJseVkyeGxJR040UFNJeU5qSWlJR041UFNJeU5qSWlJSEk5SWpVMElpQm1hV3hzUFNJalgzWTVjM1Z5Wm1GalpTSXZQZ284TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 5px;
        }
        
        .profile-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .profile-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .user .message-avatar {
            background: #4A90E2;
            color: white;
        }
        
        .assistant .message-avatar {
            background: #e8f4fd;
            color: #4A90E2;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 16px;
        }
        
        .user .message-content {
            background: #4A90E2;
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .assistant .message-content {
            background: #f1f3f5;
            color: #333;
            border-bottom-left-radius: 6px;
        }
        
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            min-height: 44px;
            max-height: 100px;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 22px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        .message-input:focus {
            border-color: #4A90E2;
        }
        
        .voice-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #4A90E2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .voice-button:hover {
            background: #357ABD;
            transform: scale(1.05);
        }
        
        .voice-button.listening {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        .voice-button.speaking {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #4A90E2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: #357ABD;
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4A90E2;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .welcome-message h2 {
            color: #4A90E2;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 20px;
            text-align: center;
            font-size: 14px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .messages {
                padding: 15px;
            }
            
            .input-area {
                padding: 15px;
                gap: 10px;
            }
            
            .message-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            }
            
            .container {
                background: #2c3e50;
                color: #ecf0f1;
            }
            
            .assistant .message-content {
                background: #34495e;
                color: #ecf0f1;
            }
            
            .message-input {
                background: #34495e;
                color: #ecf0f1;
                border-color: #4a5568;
            }
            
            .input-area {
                background: #2c3e50;
                border-color: #4a5568;
            }
        }
        
        /* Profile Modal Styles */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .profile-modal.active {
            display: block;
        }
        
        .profile-content {
            background: white;
            margin: 20px;
            padding: 0;
            border-radius: 12px;
            max-width: 600px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .profile-header {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-header h2 {
            margin: 0;
            font-weight: 300;
        }
        
        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .close-button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .profile-form {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #4A90E2;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4A90E2;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: #e8f4fd;
            border-color: #4A90E2;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }
        
        .checkbox-item.checked {
            background: #e8f4fd;
            border-color: #4A90E2;
            color: #4A90E2;
        }
        
        .profile-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #4A90E2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #357ABD;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e1e5e9;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* File upload styling */
        .file-input {
            margin-top: 8px;
            padding: 10px;
            border: 2px dashed #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-input:hover {
            border-color: #4A90E2;
            background: #e8f4fd;
        }
        
        .form-help {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }
        
        .uploaded-files {
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #e8f4fd;
            border: 1px solid #4A90E2;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .file-name {
            color: #4A90E2;
            font-weight: 500;
        }
        
        .file-size {
            color: #666;
            font-size: 12px;
        }
        
        .remove-file {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .remove-file:hover {
            background: rgba(220, 53, 69, 0.1);
        }
        
        @media (max-width: 768px) {
            .profile-content {
                margin: 10px;
            }
            
            .profile-form {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .profile-actions {
                flex-direction: column;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Talbot</h1>
            <button class="profile-button" id="profile-button">Profile</button>
            <div class="status">
                <span id="status-text">Ready to listen</span>
                <span id="status-indicator">💙</span>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <h2>Hi, I'm Talbot</h2>
                    <p>I'm here to listen and support you between therapy sessions. You can type or speak to me - whatever feels most comfortable.</p>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <div class="message-avatar">
                    <span>🤖</span>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <button class="voice-button" id="voice-button" title="Hold to speak">
                🎤
            </button>
            <div class="input-group">
                <textarea 
                    class="message-input" 
                    id="message-input" 
                    placeholder="Type your message or hold the mic button to speak..."
                    rows="1"
                ></textarea>
            </div>
            <button class="send-button" id="send-button" title="Send message">
                ➤
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profile-modal">
        <div class="profile-content">
            <div class="profile-header">
                <h2>Your Profile</h2>
                <button class="close-button" id="close-profile">×</button>
            </div>
            <form class="profile-form" id="profile-form">
                <div class="form-section">
                    <h3>Personal Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="preferred-name">Preferred Name</label>
                            <input type="text" id="preferred-name" name="preferredName" placeholder="What should Talbot call you?">
                        </div>
                        <div class="form-group">
                            <label for="age-range">Age Range</label>
                            <select id="age-range" name="ageRange">
                                <option value="">Select age range</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-45">36-45</option>
                                <option value="46-55">46-55</option>
                                <option value="56-65">56-65</option>
                                <option value="65+">65+</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Mental Health Information</h3>
                    <div class="form-group">
                        <label for="diagnoses">Current Diagnoses</label>
                        <textarea id="diagnoses" name="diagnoses" placeholder="e.g., Anxiety, Depression, ADHD, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="clinical-documents">Clinical Documents</label>
                        <p class="form-help">Upload diagnostic reports, DSM-5 criteria, treatment notes, or other clinical documents that help Talbot understand your conditions better.</p>
                        <input type="file" id="clinical-documents" name="clinicalDocuments" multiple accept=".pdf,.txt,.doc,.docx" class="file-input">
                        <div class="uploaded-files" id="uploaded-files"></div>
                    </div>
                    <div class="form-group">
                        <label for="medications">Current Medications</label>
                        <textarea id="medications" name="medications" placeholder="List your current medications and dosages (if comfortable sharing)"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="treatment-history">Treatment History</label>
                        <textarea id="treatment-history" name="treatmentHistory" placeholder="Types of therapy, what's worked, what hasn't, current therapist info, etc."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Communication Preferences</h3>
                    <div class="form-group">
                        <label>How would you like Talbot to communicate with you?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="gentle" name="communicationStyle" value="gentle">
                                <label for="gentle">Gentle & Soft</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="direct" name="communicationStyle" value="direct">
                                <label for="direct">Direct & Clear</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="encouraging" name="communicationStyle" value="encouraging">
                                <label for="encouraging">Encouraging</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="analytical" name="communicationStyle" value="analytical">
                                <label for="analytical">Analytical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="warm" name="communicationStyle" value="warm">
                                <label for="warm">Warm & Empathetic</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="custom-communication">Custom Communication Preferences</label>
                        <textarea id="custom-communication" name="customCommunication" placeholder="Describe how you'd like Talbot to communicate with you. For example: 'Ask probing questions like my therapist does', 'Use validation before offering suggestions', 'Keep responses concise', 'Challenge my thinking patterns', etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="triggers">Topics to Approach Carefully</label>
                        <textarea id="triggers" name="triggers" placeholder="Any topics or subjects that might be triggering or sensitive for you"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Current Focus Areas</h3>
                    <div class="form-group">
                        <label for="therapy-goals">Current Therapy Goals</label>
                        <textarea id="therapy-goals" name="therapyGoals" placeholder="What are you working on in therapy right now?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="coping-strategies">Coping Strategies That Work</label>
                        <textarea id="coping-strategies" name="copingStrategies" placeholder="What techniques, activities, or strategies help you feel better?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="current-stressors">Current Life Stressors</label>
                        <textarea id="current-stressors" name="currentStressors" placeholder="What's causing stress or difficulty in your life right now?"></textarea>
                    </div>
                </div>

                <div class="profile-actions">
                    <button type="button" class="btn btn-danger" id="clear-profile">Clear Profile</button>
                    <button type="button" class="btn btn-secondary" id="cancel-profile">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class TalbotApp {
            constructor() {
                this.messages = [];
                this.isListening = false;
                this.isSpeaking = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.currentUtterance = null;
                this.profile = null;
                
                this.initializeElements();
                this.initializeSpeech();
                this.bindEvents();
                this.loadProfile();
                this.registerServiceWorker();
            }
            
            initializeElements() {
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.voiceButton = document.getElementById('voice-button');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.statusText = document.getElementById('status-text');
                this.statusIndicator = document.getElementById('status-indicator');
                
                // Profile elements
                this.profileButton = document.getElementById('profile-button');
                this.profileModal = document.getElementById('profile-modal');
                this.profileForm = document.getElementById('profile-form');
                this.closeProfile = document.getElementById('close-profile');
                this.cancelProfile = document.getElementById('cancel-profile');
                this.clearProfile = document.getElementById('clear-profile');
                this.clinicalDocuments = document.getElementById('clinical-documents');
                this.uploadedFiles = document.getElementById('uploaded-files');
                
                // File storage for documents
                this.documentContents = [];
            }
            
            // Enhanced Speech Synthesis initialization
            initializeSpeech() {
                // Speech Recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.updateVoiceButton();
                        this.updateStatus('Listening...', '👂');
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.messageInput.value = transcript;
                        this.sendMessage();
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showError('Voice recognition error. Please try again.');
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                } else {
                    this.voiceButton.style.display = 'none';
                    this.showError('Voice recognition not supported in this browser.');
                }
                
                // Enhanced Speech Synthesis initialization
                if (this.synthesis) {
                    // Wait for voices to load (especially important on Chrome)
                    this.loadVoices();
                    
                    // Handle voice changes (when voices are loaded asynchronously)
                    if (speechSynthesis.onvoiceschanged !== undefined) {
                        speechSynthesis.onvoiceschanged = () => {
                            this.loadVoices();
                        };
                    }
                }
            }
            
            loadVoices() {
                const voices = this.synthesis.getVoices();
                console.log(`Loaded ${voices.length} voices:`);
                voices.forEach((voice, index) => {
                    console.log(`${index}: ${voice.name} (${voice.lang}) ${voice.localService ? '[Local]' : '[Remote]'} ${voice.default ? '[Default]' : ''}`);
                });
                
                // Pre-select the best voice for immediate use
                const bestVoice = this.selectBestVoice(voices);
                if (bestVoice) {
                    console.log(`Pre-selected best voice: ${bestVoice.name}`);
                }
            }
            
            bindEvents() {
                // Send button
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                // Enter key to send (but shift+enter for new line)
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 100) + 'px';
                });
                
                // Voice button - touch events for mobile
                this.voiceButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startListening();
                });
                
                this.voiceButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopListening();
                });
                
                // Voice button - mouse events for desktop
                this.voiceButton.addEventListener('mousedown', () => this.startListening());
                this.voiceButton.addEventListener('mouseup', () => this.stopListening());
                this.voiceButton.addEventListener('mouseleave', () => this.stopListening());
                
                // Stop speech when user starts typing
                this.messageInput.addEventListener('input', () => {
                    if (this.isSpeaking) {
                        this.stopSpeaking();
                    }
                });
                
                // Profile modal events
                this.profileButton.addEventListener('click', () => this.openProfile());
                this.closeProfile.addEventListener('click', () => this.closeProfileModal());
                this.cancelProfile.addEventListener('click', () => this.closeProfileModal());
                this.clearProfile.addEventListener('click', () => this.clearProfileData());
                this.profileForm.addEventListener('submit', (e) => this.saveProfile(e));
                
                // Close modal when clicking outside
                this.profileModal.addEventListener('click', (e) => {
                    if (e.target === this.profileModal) {
                        this.closeProfileModal();
                    }
                });
                
                // Checkbox styling
                document.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox' && e.target.name === 'communicationStyle') {
                        const item = e.target.closest('.checkbox-item');
                        if (e.target.checked) {
                            item.classList.add('checked');
                        } else {
                            item.classList.remove('checked');
                        }
                    }
                });
                
                // File upload handling
                this.clinicalDocuments.addEventListener('change', (e) => this.handleFileUpload(e));
            }
            
            async handleFileUpload(event) {
                const files = Array.from(event.target.files);
                
                for (const file of files) {
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        this.showMessage(`File "${file.name}" is too large. Maximum size is 5MB.`, 'error');
                        continue;
                    }
                    
                    try {
                        const content = await this.readFileContent(file);
                        const fileData = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            content: content,
                            id: Date.now() + Math.random()
                        };
                        
                        this.documentContents.push(fileData);
                        this.displayUploadedFile(fileData);
                        
                    } catch (error) {
                        console.error('Error reading file:', error);
                        this.showMessage(`Error reading file "${file.name}". Please try again.`, 'error');
                    }
                }
                
                // Clear the input
                event.target.value = '';
            }
            
            async readFileContent(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        let content = e.target.result;
                        
                        // For text files, return the content directly
                        if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                            resolve(content);
                        } else {
                            // For other file types, store the filename and basic info
                            // In a real implementation, you'd use proper document parsing libraries
                            resolve(`Document: ${file.name} (${this.formatFileSize(file.size)})\nType: ${file.type}\n\n[Document content would be extracted here]`);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    
                    if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                        reader.readAsText(file);
                    } else {
                        // For non-text files, we'll store metadata for now
                        resolve(`Document: ${file.name} (${this.formatFileSize(file.size)})\nType: ${file.type}\n\n[Document uploaded - content parsing would be implemented here]`);
                    }
                });
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            displayUploadedFile(fileData) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${this.formatFileSize(fileData.size)}</div>
                    </div>
                    <button type="button" class="remove-file" data-file-id="${fileData.id}" title="Remove file">×</button>
                `;
                
                // Add remove functionality
                fileItem.querySelector('.remove-file').addEventListener('click', () => {
                    this.removeUploadedFile(fileData.id);
                    fileItem.remove();
                });
                
                this.uploadedFiles.appendChild(fileItem);
            }
            
            removeUploadedFile(fileId) {
                this.documentContents = this.documentContents.filter(doc => doc.id !== fileId);
            }
            
            startListening() {
                if (this.recognition && !this.isListening) {
                    this.recognition.start();
                }
            }
            
            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                    this.updateVoiceButton();
                    this.updateStatus('Ready to listen', '💙');
                }
            }
            
            updateVoiceButton() {
                if (this.isListening) {
                    this.voiceButton.classList.add('listening');
                    this.voiceButton.innerHTML = '⏹️';
                } else if (this.isSpeaking) {
                    this.voiceButton.classList.add('speaking');
                    this.voiceButton.innerHTML = '🔊';
                } else {
                    this.voiceButton.classList.remove('listening', 'speaking');
                    this.voiceButton.innerHTML = '🎤';
                }
            }
            
            updateStatus(text, indicator) {
                this.statusText.textContent = text;
                this.statusIndicator.textContent = indicator;
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                // Add user message
                this.addMessage('user', message);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                // Show typing indicator
                this.showTyping();
                this.updateStatus('Talbot is thinking...', '🤔');
                
                try {
                    const response = await this.getAIResponse(message);
                    
                    this.hideTyping();
                    this.addMessage('assistant', response);
                    this.speakMessage(response);
                    this.updateStatus('Ready to listen', '💙');
                } catch (error) {
                    this.hideTyping();
                    this.showError('Sorry, I had trouble processing that. Please try again.');
                    this.updateStatus('Ready to listen', '💙');
                }
            }
            
            async getAIResponse(message) {
                try {
                    // Include profile context if available
                    const contextualMessage = this.buildContextualMessage(message);
                    
                    // Call our Netlify function instead of Claude API directly
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: contextualMessage,
                            profile: this.profile
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Function request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.response;
                    
                } catch (error) {
                    console.error('Error calling chat function:', error);
                    
                    // Fallback responses if function fails
                    const fallbackResponses = [
                        "I'm having trouble connecting right now, but I'm still here to listen. Can you tell me more about what's on your mind?",
                        "I'm experiencing some technical difficulties, but your feelings are important. What would help you feel supported right now?",
                        "I'm here for you, even though I'm having connection issues. How are you feeling in this moment?"
                    ];
                    
                    return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                }
            }
            
            buildContextualMessage(message) {
                if (!this.profile) return message;
                
                let context = "User Profile Context:\n";
                
                if (this.profile.preferredName) {
                    context += `- Call me: ${this.profile.preferredName}\n`;
                }
                
                if (this.profile.diagnoses) {
                    context += `- Mental health conditions: ${this.profile.diagnoses}\n`;
                }
                
                // Include clinical document content
                if (this.documentContents && this.documentContents.length > 0) {
                    context += `- Clinical Documentation:\n`;
                    this.documentContents.forEach(doc => {
                        context += `  * ${doc.name}:\n${doc.content}\n\n`;
                    });
                }
                
                if (this.profile.medications) {
                    context += `- Current medications: ${this.profile.medications}\n`;
                }
                
                if (this.profile.treatmentHistory) {
                    context += `- Treatment background: ${this.profile.treatmentHistory}\n`;
                }
                
                if (this.profile.communicationStyle && this.profile.communicationStyle.length > 0) {
                    context += `- Communication preferences: ${this.profile.communicationStyle.join(', ')}\n`;
                }
                
                if (this.profile.customCommunication) {
                    context += `- Custom communication instructions: ${this.profile.customCommunication}\n`;
                }
                
                if (this.profile.triggers) {
                    context += `- Sensitive topics: ${this.profile.triggers}\n`;
                }
                
                if (this.profile.therapyGoals) {
                    context += `- Current therapy goals: ${this.profile.therapyGoals}\n`;
                }
                
                if (this.profile.copingStrategies) {
                    context += `- Effective coping strategies: ${this.profile.copingStrategies}\n`;
                }
                
                if (this.profile.currentStressors) {
                    context += `- Current stressors: ${this.profile.currentStressors}\n`;
                }
                
                return context + "\nUser message: " + message;
            }
            
            // Enhanced voice functionality with natural speech
            speakMessage(text) {
                if (!this.synthesis) return;
                
                // Stop any current speech
                this.stopSpeaking();
                
                // Pre-process text for more natural speech
                const naturalText = this.makeTextMoreNatural(text);
                
                this.currentUtterance = new SpeechSynthesisUtterance(naturalText);
                
                // Enhanced voice settings for warmth and humanity
                this.currentUtterance.rate = 0.85;  // Slightly slower for thoughtfulness
                this.currentUtterance.pitch = 1.1;  // Slightly higher for warmth
                this.currentUtterance.volume = 0.9; // Clear but not harsh
                
                // Try to find the most natural, warm voice
                const voices = this.synthesis.getVoices();
                const bestVoice = this.selectBestVoice(voices);
                
                if (bestVoice) {
                    this.currentUtterance.voice = bestVoice;
                    console.log('Using voice:', bestVoice.name);
                }
                
                // Add natural pauses and emphasis events
                this.addEmphasisEvents(this.currentUtterance, text);
                
                this.currentUtterance.onstart = () => {
                    this.isSpeaking = true;
                    this.updateVoiceButton();
                    this.updateStatus('Talbot is speaking...', '🗣️');
                };
                
                this.currentUtterance.onend = () => {
                    this.isSpeaking = false;
                    this.updateVoiceButton();
                    this.updateStatus('Ready to listen', '💙');
                };
                
                this.currentUtterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    this.isSpeaking = false;
                    this.updateVoiceButton();
                    this.updateStatus('Ready to listen', '💙');
                };
                
                // Small delay to ensure voice selection works
                setTimeout(() => {
                    this.synthesis.speak(this.currentUtterance);
                }, 100);
            }
            
            makeTextMoreNatural(text) {
                // Add natural speech patterns and pauses
                let naturalText = text;
                
                // Add thoughtful pauses before important phrases
                naturalText = naturalText.replace(/\. (I understand|I hear|That sounds|It sounds like)/g, '. ... $1');
                naturalText = naturalText.replace(/\. (How are|What|When|Where|Why)/g, '. ... $1');
                
                // Add gentle emphasis to empathetic words
                naturalText = naturalText.replace(/\b(understand|hear you|valid|important|strength|brave|proud)\b/g, '$1');
                
                // Add natural breathing pauses
                naturalText = naturalText.replace(/([.!?])\s+([A-Z])/g, '$1 ... $2');
                
                // Soften clinical language
                naturalText = naturalText.replace(/\btechniques\b/g, 'ways that might help');
                naturalText = naturalText.replace(/\bstrategies\b/g, 'things you can try');
                naturalText = naturalText.replace(/\bimplement\b/g, 'try');
                
                // Add conversational connectors
                naturalText = naturalText.replace(/^(Here are|These are)/g, 'Some things that might help are');
                naturalText = naturalText.replace(/\bAdditionally\b/g, 'Also');
                naturalText = naturalText.replace(/\bFurthermore\b/g, 'And');
                
                return naturalText;
            }
            
            selectBestVoice(voices) {
                if (!voices || voices.length === 0) return null;
                
                // Voice quality rankings for warmth and naturalness
                const voicePreferences = [
                    // iOS/Safari voices (highest quality)
                    { name: 'Samantha', score: 100 },
                    { name: 'Allison', score: 95 },
                    { name: 'Ava', score: 90 },
                    { name: 'Susan', score: 85 },
                    { name: 'Karen', score: 80 },
                    
                    // Google/Chrome voices
                    { name: 'Google UK English Female', score: 85 },
                    { name: 'Google US English Female', score: 80 },
                    { name: 'Microsoft Emma Online', score: 75 },
                    { name: 'Microsoft Jenny Online', score: 75 },
                    
                    // Windows voices
                    { name: 'Microsoft Zira Desktop', score: 70 },
                    { name: 'Microsoft Eva Desktop', score: 65 },
                    
                    // Fallback preferences
                    { pattern: /samantha/i, score: 95 },
                    { pattern: /allison/i, score: 90 },
                    { pattern: /ava/i, score: 85 },
                    { pattern: /karen/i, score: 80 },
                    { pattern: /emma/i, score: 75 },
                    { pattern: /jenny/i, score: 75 },
                    { pattern: /female.*english/i, score: 70 },
                    { pattern: /english.*female/i, score: 70 },
                    { pattern: /woman/i, score: 65 },
                    { pattern: /female/i, score: 60 }
                ];
                
                let bestVoice = null;
                let highestScore = 0;
                
                voices.forEach(voice => {
                    // Only consider English voices
                    if (!voice.lang.startsWith('en')) return;
                    
                    let score = 0;
                    
                    // Check exact name matches first
                    const exactMatch = voicePreferences.find(pref => 
                        pref.name && voice.name === pref.name
                    );
                    if (exactMatch) {
                        score = exactMatch.score;
                    } else {
                        // Check pattern matches
                        const patternMatch = voicePreferences.find(pref => 
                            pref.pattern && pref.pattern.test(voice.name)
                        );
                        if (patternMatch) {
                            score = patternMatch.score;
                        }
                    }
                    
                    // Boost score for local voices (better quality)
                    if (voice.localService) {
                        score += 10;
                    }
                    
                    // Slight preference for default voices
                    if (voice.default) {
                        score += 5;
                    }
                    
                    console.log(`Voice: ${voice.name} (${voice.lang}) - Score: ${score}`);
                    
                    if (score > highestScore) {
                        highestScore = score;
                        bestVoice = voice;
                    }
                });
                
                return bestVoice;
            }
            
            addEmphasisEvents(utterance, originalText) {
                // Add boundary events for more natural pacing
                utterance.onboundary = (event) => {
                    // This can be used for future enhancements like real-time emphasis
                    if (event.name === 'sentence') {
                        // Could add visual feedback or adjust rate here
                    }
                };
            }
            
            stopSpeaking() {
                if (this.synthesis && this.isSpeaking) {
                    this.synthesis.cancel();
                    this.isSpeaking = false;
                    this.updateVoiceButton();
                    this.updateStatus('Ready to listen', '💙');
                }
            }
            
            addMessage(sender, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = sender === 'user' ? '👤' : '🤖';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                // Remove welcome message if it exists
                const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                this.messages.push({ sender, content, timestamp: new Date() });
            }
            
            showTyping() {
                this.typingIndicator.style.display = 'flex';
                this.scrollToBottom();
            }
            
            hideTyping() {
                this.typingIndicator.style.display = 'none';
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                document.querySelector('.chat-container').insertBefore(errorDiv, this.messagesContainer);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            // Profile Management Methods
            loadProfile() {
                try {
                    const savedProfile = localStorage.getItem('talbot-profile');
                    if (savedProfile) {
                        this.profile = JSON.parse(savedProfile);
                        this.populateProfileForm();
                        
                        // Update welcome message if profile exists
                        const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
                        if (welcomeMessage && this.profile.preferredName) {
                            welcomeMessage.querySelector('h2').textContent = `Hi, ${this.profile.preferredName}`;
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }
            
            saveProfile(e) {
                e.preventDefault();
                
                const formData = new FormData(this.profileForm);
                const profile = {};
                
                // Get text inputs
                for (let [key, value] of formData.entries()) {
                    if (key !== 'communicationStyle') {
                        profile[key] = value.trim();
                    }
                }
                
                // Get communication style checkboxes
                const communicationStyles = [];
                document.querySelectorAll('input[name="communicationStyle"]:checked').forEach(checkbox => {
                    communicationStyles.push(checkbox.value);
                });
                profile.communicationStyle = communicationStyles;
                
                // Save to localStorage
                try {
                    localStorage.setItem('talbot-profile', JSON.stringify(profile));
                    localStorage.setItem('talbot-documents', JSON.stringify(this.documentContents));
                    this.profile = profile;
                    
                    // Update welcome message
                    const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
                    if (welcomeMessage && profile.preferredName) {
                        welcomeMessage.querySelector('h2').textContent = `Hi, ${profile.preferredName}`;
                    }
                    
                    this.closeProfileModal();
                    this.showMessage('Profile and documents saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving profile:', error);
                    this.showMessage('Error saving profile. Please try again.', 'error');
                }
            }
            
            loadProfile() {
                try {
                    const savedProfile = localStorage.getItem('talbot-profile');
                    const savedDocuments = localStorage.getItem('talbot-documents');
                    
                    if (savedProfile) {
                        this.profile = JSON.parse(savedProfile);
                        this.populateProfileForm();
                        
                        // Update welcome message if profile exists
                        const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
                        if (welcomeMessage && this.profile.preferredName) {
                            welcomeMessage.querySelector('h2').textContent = `Hi, ${this.profile.preferredName}`;
                        }
                    }
                    
                    if (savedDocuments) {
                        this.documentContents = JSON.parse(savedDocuments);
                        this.displaySavedDocuments();
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }
            
            displaySavedDocuments() {
                this.uploadedFiles.innerHTML = '';
                this.documentContents.forEach(fileData => {
                    this.displayUploadedFile(fileData);
                });
            }
            
            populateProfileForm() {
                if (!this.profile) return;
                
                // Populate text inputs
                Object.keys(this.profile).forEach(key => {
                    if (key !== 'communicationStyle') {
                        const element = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                        if (element) {
                            element.value = this.profile[key];
                        }
                    }
                });
                
                // Populate communication style checkboxes
                if (this.profile.communicationStyle) {
                    this.profile.communicationStyle.forEach(style => {
                        const checkbox = document.getElementById(style);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.closest('.checkbox-item').classList.add('checked');
                        }
                    });
                }
            }
            
            openProfile() {
                this.profileModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            closeProfileModal() {
                this.profileModal.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            clearProfileData() {
                if (confirm('Are you sure you want to clear your profile and all uploaded documents? This cannot be undone.')) {
                    localStorage.removeItem('talbot-profile');
                    localStorage.removeItem('talbot-documents');
                    this.profile = null;
                    this.documentContents = [];
                    this.profileForm.reset();
                    this.uploadedFiles.innerHTML = '';
                    
                    // Clear checkbox styling
                    document.querySelectorAll('.checkbox-item.checked').forEach(item => {
                        item.classList.remove('checked');
                    });
                    
                    // Reset welcome message
                    const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.querySelector('h2').textContent = 'Hi, I\'m Talbot';
                    }
                    
                    this.closeProfileModal();
                    this.showMessage('Profile and documents cleared successfully.', 'success');
                }
            }
            
            showMessage(text, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `status-message status-${type}`;
                messageDiv.textContent = text;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#4A90E2'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 1001;
                    font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        // Create a simple service worker inline for caching
                        const swCode = `
                            const CACHE_NAME = 'talbot-v1';
                            const urlsToCache = [
                                '/',
                                '/index.html'
                            ];
                            
                            self.addEventListener('install', (event) => {
                                event.waitUntil(
                                    caches.open(CACHE_NAME)
                                        .then((cache) => cache.addAll(urlsToCache))
                                );
                            });
                            
                            self.addEventListener('fetch', (event) => {
                                event.respondWith(
                                    caches.match(event.request)
                                        .then((response) => {
                                            return response || fetch(event.request);
                                        })
                                );
                            });
                        `;
                        
                        const blob = new Blob([swCode], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        
                        await navigator.serviceWorker.register(swUrl);
                        console.log('Service Worker registered successfully');
                    } catch (error) {
                        console.log('Service Worker registration failed:', error);
                    }
                }
            }
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new TalbotApp();
        });
        
        // Handle iOS viewport height issues
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });
    </script>
</body>
</html>
